# Система компьютерного зрения для поиска археологических объектов с FPV-дрона

## Обзор

Этот проект представляет собой комплексную систему компьютерного зрения, предназначенную для установки на FPV-дрон с целью обнаружения и идентификации археологических построек в реальном времени. Система использует нейросетевую модель **YOLOv8** для детекции объектов, многопоточную обработку видео для высокой производительности и интеграцию с GPS для точного логирования координат находок.

### Ключевые возможности

- **Детекция в реальном времени**: Обнаружение археологических объектов на видеопотоке с дрона с использованием YOLOv8.
- **Многопоточная архитектура**: Оптимизированная производительность за счет разделения захвата, обработки и отображения кадров на отдельные потоки.
- **GPS-логирование**: Автоматическое сохранение GPS-координат, высоты и курса дрона в момент обнаружения объекта.
- **Генерация отчетов**: Создание подробных логов миссии в форматах JSON, CSV и KML (для Google Earth).
- **Гибкая конфигурация**: Легкая настройка параметров через YAML-файл.
- **Режим симуляции**: Возможность тестирования и отладки без подключения к реальному дрону.
- **Модульная структура**: Легко расширяемый и модифицируемый код.

### Обнаруживаемые объекты

Система настроена на обнаружение следующих типов археологических объектов (модель требует дообучения на специализированном датасете):

- Древние руины и фундаменты (`ruins`, `foundation`)
- Курганы и насыпи (`mound`)
- Каменные структуры (`stone_structure`)
- Геоглифы и земляные сооружения (`geoglyph`, `earthwork`)

---

## Архитектура системы

Проект состоит из нескольких ключевых модулей, работающих совместно:

1.  **`main.py`**: Главный скрипт, который инициализирует все компоненты и управляет логикой приложения. Отвечает за парсинг аргументов командной строки и запуск системы.

2.  **`models/archaeological_detector.py`**: Модуль детекции. Содержит класс `ArchaeologicalDetector`, который загружает модель YOLO, выполняет предсказания на кадрах и аннотирует изображения.

3.  **`utils/video_processor.py`**: Модуль обработки видео. Включает классы `VideoStreamProcessor` и `RTSPStreamProcessor` для эффективного захвата и обработки видеопотока в многопоточном режиме, что минимизирует задержки и пропуски кадров.

4.  **`utils/drone_integration.py`**: Модуль интеграции с дроном. Содержит классы `DroneController` для получения телеметрии через MAVLink (с использованием DroneKit) и `GPSLogger` для записи координат, траектории полета и создания отчетов.

5.  **`config/config.yaml`**: Файл конфигурации, позволяющий настраивать все основные параметры системы без изменения кода.

6.  **`requirements.txt`**: Список всех необходимых Python-библиотек для работы проекта.

---

## Установка и запуск

### 1. Клонирование проекта

```bash
git clone <URL_репозитория>
cd fpv_archaeology_cv
```

### 2. Установка зависимостей

Убедитесь, что у вас установлен Python 3.9+ и pip. Затем выполните команду:

```bash
pip install -r requirements.txt
```

Для использования GPU (рекомендуется для высокой производительности) необходимо установить PyTorch с поддержкой CUDA:

```bash
# Уточните команду на официальном сайте PyTorch под вашу версию CUDA
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
```

### 3. Настройка

Отредактируйте файл `config/config.yaml` для настройки параметров:

- **`model.path`**: Укажите путь к весам модели YOLO. Вы можете использовать стандартные (`yolov8n.pt`, `yolov8s.pt`) или обучить свою модель.
- **`video.source`**: Укажите источник видео (веб-камера `0`, видеофайл `path/to/video.mp4`, RTSP-поток `rtsp://...`).
- **`drone.connection_string`**: Укажите строку подключения к вашему дрону (например, `/dev/ttyUSB0` для Serial или `127.0.0.1:14550` для SITL).
- **`drone.simulation_mode`**: Установите `false` для работы с реальным дроном.

### 4. Запуск

Система запускается из командной строки. Используйте флаг `--help` для просмотра всех доступных опций.

```bash
python3 main.py --help
```

**Примеры команд:**

- **Обработка с веб-камеры в режиме симуляции GPS:**
  ```bash
  python3 main.py --source 0 --display
  ```

- **Обработка RTSP-потока с дрона и реальным GPS:**
  ```bash
  python3 main.py --source rtsp://192.168.1.1:8554/stream --rtsp --drone-connection /dev/ttyAMA0 --no-simulation
  ```

- **Обработка видеофайла с сохранением результата:**
  ```bash
  python3 main.py --source input.mp4 --output output.mp4
  ```

- **Детекция на одном изображении:**
  ```bash
  python3 main.py --image photo.jpg --output result.jpg --display
  ```

### Управление во время работы

- **`Q`**: Завершить работу.
- **`P`**: Поставить на паузу или возобновить обработку.
- **`S`**: Сохранить текущий кадр в виде снимка (`snapshot_...jpg`).

---

## Результаты работы

Система генерирует следующие артефакты в директориях `logs/` и `detections/`:

- **`detections/`**: Сохраненные изображения (кропы) всех обнаруженных объектов.
- **`logs/{mission_name}_detections.json`**: Подробный JSON-отчет со всеми детекциями, их параметрами и GPS-данными.
- **`logs/{mission_name}_trajectory.csv`**: CSV-файл с полной траекторией полета дрона (timestamp, lat, lon, alt).
- **`logs/{mission_name}_detections.kml`**: KML-файл для импорта в Google Earth или другие ГИС-системы. Отображает метки всех находок на карте.

---

## Дальнейшее развитие

- **Обучение модели**: Для повышения точности необходимо собрать датасет с аэрофотоснимками реальных археологических объектов и дообучить модель YOLOv8.
- **Интеграция с автопилотом**: Реализация функций автоматического облета обнаруженного объекта или отправки команд дрону (например, зависнуть для детального осмотра).
- **Пользовательский интерфейс**: Создание веб-интерфейса для управления миссиями и просмотра результатов в реальном времени.
- **Использование LiDAR**: Интеграция данных с LiDAR для построения 3D-моделей рельефа и более точного обнаружения скрытых объектов.
